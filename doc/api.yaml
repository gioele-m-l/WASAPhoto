openapi: 3.0.3


info:
  title: WASAPhoto API specifications
  description: |
    API specifications of WASAPhoto, exam's project for
    the course Web and Software Architecture 2023/2024.
  version: 0.0.1



servers:
  - url: http://localhost:2324



tags:
  - name: Login
  - name: User Operations
  - name: Photo Operations



components:
#### SECURITY SCHEMES ####
  securitySchemes:

# BearerAuthentication #
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: string


#### SCHEMAS ####
  schemas:

### USER RELATED SCHEMAS ###

# User schema #
    User:
      title: User
      description: |
        This object represents a single user and it's information.
      
      type: object
      properties:
        user-id:
          description: |
            Main identifier of the user object, it can't be modified by the user.
          type: integer
          readOnly: true
          minimum: 1
          example: 1

        username:
          description: |
            Name that the user has chosen, the user can be
            found by other user with the username, a user
            can change its username.
          type: string
          example: Mario
          pattern: '^.*?$'
          minLength: 3
          maxLength: 16

        followers-count:
          description: |
            The number of users that follow this user.
          type: integer
          readOnly: true
          minimum: 0
          example: 10
        
        followings-count:
          description: |
            The number of users that this user follows.
          type: integer
          readOnly: true
          minimum: 0
          example: 10
        
        photos-count:
          description: |
            The number of photos of this user.
          type: integer
          readOnly: true
          minimum: 0
          example: 10
        
        profile-image-path:
          description: |
            String with the path to the profile image of this user.
          type: string
          format: uri

# User summary schema # 
    User-summary:
      title: User summary
      description: |
        Summary of User object infos
      type: object
      properties:
        user-id:        { $ref: "#/components/schemas/User/properties/user-id" }
        username:       { $ref: "#/components/schemas/User/properties/username" }
        profile-image-path:  { $ref: "#/components/schemas/User/properties/profile-image-path" }

### PHOTO RELATED SCHEMAS ###

# Image schema #
    Image:
      title: Image file
      description: |
        Binary string that represents an image.
      type: string
      format: binary

# Photo schema #
    Photo:
      title: Photo
      description: |
        This object represents a single photo and it's informations.
      
      type: object
      properties:
        photo-id:
          description: |
            Identifier of the photo object.
          type: integer
          minimum: 0
          readOnly: true
      
        timestamp:
          description: |
            Date and time of creation of this object.
          type: string
          format: date-time
          readOnly: true
        
        owner: { $ref: "#/components/schemas/User/properties/user-id" } # Utilizzo l'user-id del proprietario

        image-path:
          description: |
            Path to the image file.
          type: string
          format: uri
          readOnly: true
        
        likes-count:
          description: |
            Number of likes of this photo.
          type: integer
          minimum: 0
          readOnly: true
        
        comments-count:
          description: |
            Number of comments of this photo.
          type: integer
          minimum: 0
          readOnly: true
        
        caption:
          description: |
            Short text that can describe the photo, chosen by the owner.
          type: string
          minLength: 0
          maxLength: 100
          readOnly: false
    
    Comment:
      title: Comment
      description: |
        This object represent a comment, with a comment-id and a text.
      
      type: object
      properties:
        comment-id:
          description: |
            Identifier of the comment object.
          type: integer
          minimum: 0
          readOnly: true
        
        timestamp:
          description: |
            The timestamp of this comment.
          type: string
          format: date-time
          readOnly: true
        
        text:
          description: |
            Short text for the user to tell something.
          type: string
          minLength: 0
          maxLength: 256
          readOnly: false



paths:

  /login:
    post:
      tags : ["Login"]
      summary: Logs in the user
      description: |
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      
      operationId: doLogin
      
      requestBody:
        description: User details
        content:
          application/json:
            schema:
              type: object
              properties:
                username: { $ref: "#/components/schemas/User/properties/username" }
        required: true

      responses:
        "201":
          description:  User log-in action successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user-id: { $ref: "#/components/schemas/User/properties/user-id" }
                  auth-token: { $ref: "#/components/securitySchemes/BearerAuth/bearerFormat" }

### USER OPERATIONS ###
  /users/:
    parameters: 
      - name: search
        in: query
        schema: { $ref: "#/components/schemas/User/properties/username" }
        required: false
    
    get:
      tags: ["User Operations"]
      summary: Return a list of user-summary objs
      description: |
        Return a list of user-summary objects, given an username return the
        relative user-summary object.

      operationId: listUsers
      
      security:
        - BearerAuth: []
      
      responses:
        "200":
          description: Successfully returned a list of users
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/User-summary" }
                minItems: 0
                maxItems: 100
        
        "400":
          description: The parameter 'search' must be a string

  /users/{username}/:
    parameters:
      - name: username
        in: path
        required: true
        schema: { $ref: "#/components/schemas/User/properties/username" }
    
    get:
      tags: ["User Operations"]
      summary: Get the user informations of a single user
      description: |
        Return a User object relative to the specified username.
      
      operationId: getUserProfile

      security:
        - BearerAuth: []
      
      responses:
        "200":
          description: User successfully returned
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }
        
        "400":
          description: The specified username in path must be a string
        "404":
          description: User not found
      
  /users/{username}/username:
    parameters:
      - name: username
        in: path
        required: true
        allowEmptyValue: false
        schema: { $ref: "#/components/schemas/User/properties/username" }

    put:
      tags: ["User Operations"]
      summary: Change the username
      description: |
        Change the username by chosing another valid one, an username to be valid
        must match the regex defined in the User schema and must not be already
        in use by another user.
      
      operationId: setMyUserName

      security:
        - BearerAuth: []
      
      requestBody:
        content:
          application/json:
            schema: 
              type: object
              properties: 
                new-username: { $ref: "#/components/schemas/User/properties/username" }
      
      responses:
        "200":
          description: Username changed successfully, return an User-summary object
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User-summary" }
        
        "400":
          description: The username must match the regex defined in the schema User
        
        "401":
          description: You must be logged in in order to make the request
        
        "403":
          description: The username is already in use or you are trying to change someone else's username
        
        "404":
          description: The user was not found
  

  # AGGIUNGERE PATH followed e followers

  /users/{username}/followed/{user-id}:
    parameters:
      - name: username
        in: path
        schema: { $ref: "#/components/schemas/User/properties/username" }
        required: true
      - name: user-id
        in: path
        schema: { $ref: "#/components/schemas/User/properties/user-id" }
        required: true
    
    put:
      tags: ["User Operations"]
      summary: Follow user
      description: |
        Add the specified user-id of an User to the followed users list of this user.
      
      operationId: followUser

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: User followed successfully
        
        "400":
          description: |
            'username' in path must be a string and 'user-id' must be an integer.
        
        "404":
          description: user-id not found.
    
    delete:
      tags: [User Operations]
      summary: Unfollow user
      description: |
        Remove the specified user-id of an User to the followed users list of this user.
      
      operationId: unfollowUser

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: User unfollowed successfully
        
        "400":
          description: |
            'username' in path must be a string and 'user-id' must be an integer.
        
        "404":
          description: user-id not found.

  /users/{username}/banned/{user-id}:
    parameters:
      - name: username
        in: path
        schema: { $ref: "#/components/schemas/User/properties/username" }
        required: true
      - name: user-id
        in: path
        schema: { $ref: "#/components/schemas/User/properties/user-id" }
        required: true
    
    put:
      tags: ["User Operations"]
      summary: Ban user
      description: |
        Add the specified user-id to the banned list of this user.
      
      operationId: banUser

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: User banned successfully
        
        "400":
          description: |
            'username' in path must be a string and 'user-id' must be an integer.
        
        "404":
          description: user-id not found.
    
    delete:
      tags: ["User Operations"]
      summary: Unban user
      description: |
        Remove the specified user-id from the banned list of this User.
      
      operationId: unbanUser

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: User unbanned successfully
        
        "400":
          description: |
            'username' in path must be a string and 'user-id' must be an integer.
        
        "404":
          description: user-id not found.


### PHOTO OPERATIONS ###
  /photos/:
    
    get:
      parameters:
      - name: page
        in: query
        description: |
          This parameter is used to load a specified array of photo objects,
          incrementing this number the server returns you new array of photos.
        required: false
        schema:
          type: integer
          minimum: 1
          maximum: 100
          default: 1
      - name: numberOfPhotos
        in: query
        description: |
          This parameter is used to tell the server how many photos you want per page,
          the minimum is 0, the maximum is 20 and the default is 12.
        required: false
        schema:
          type: integer
          minimum: 0
          maximum: 20
          default: 12
      
      tags: ["Photo Operations"]
      summary: Get the stream of photos
      description: |
        Return an array of photos in reverse chronological order, different photos are
        returned based on the page number.
      
      operationId: getMyStream

      security:
        - BearerAuth: []
      
      responses:
        "200":
          description: Array of photos successfully returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    type: integer
                    minimum: 1
                    maximum: 100
                    default: 1
                  photos:
                    type: array
                    items: { $ref: "#/components/schemas/Photo" }
                    minItems: 0
                    maxItems: 20
                    default: 12

        "400":
          description: The parameters must be integers and must be inbounds.
        
        "401":
          description: You have to login
    
    post:
      tags: ["Photo Operations"]
      summary: Post a photo
      description: |
        Publish a photo with informations related to it and the image file.
      
      operationId: uploadPhoto

      security:
        - BearerAuth: []
      
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                caption:
                  type: string
                  minLength: 0
                  maxLength: 100
                
                image: { $ref: "#/components/schemas/Image" }
              required:
                - image
            encoding:
              image:
                contentType: image/png, image/jpeg
      
      responses:
        "200":
          description: Photo uploaded successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Photo" }
        
        "400":
          description: Something is wrong in the request
        
        "401":
          description: Before uploading a photo you must be logged in

  /photos/{photo-id}/:
    parameters:
      - name: photo-id
        in: path
        required: true
        schema: { $ref: "#/components/schemas/Photo/properties/photo-id" }
    
    delete:
      tags: ["Photo Operations"]
      summary: Delete a photo
      description: |
        Delete the specified photo object, also delete all the likes, the comments and the image file
        related to this object.
      
      operationId: deletePhoto

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: Photo deleted successfully
        
        "400":
          description: Something is wrong with the type of the photo-id parameter
        
        "401":
          description: You must be logged in before deleting a photo
        
        "403":
          description: You can't delete someone else's photo
        
        "404":
          description: The specified photo was not found
  
  /images/{image-id}:
    parameters:
      - name: image-id
        in: path
        required: true
        schema:
          type: string
          pattern: "^[a-zA-Z0-9_-]+\\.[a-zA-Z]{3}$"
    
    get:
      tags: ["Photo Operations"]
      summary: Get an image
      description: |
        Given the specified path, return the image file.
      
      operationId: getImageFile

      security:
        - BearerAuth: []
      
      responses:
        "200":
          description: Image file returned successfully
          content:
            image/*:
              schema: { $ref: "#/components/schemas/Image" }
        
        "400":
          description: Invalid image path
        
        "401":
          description: You need to login first
        
        "403":
          description: You cannot retrieve this file
        
        "404":
          description: Image not found
  
  /photos/{photo-id}/likes/{user-id}:
    parameters:
      - name: photo-id
        in: path
        required: true
        schema: { $ref: "#/components/schemas/Photo/properties/photo-id" }
      - name: user-id
        in: path
        required: true
        schema: { $ref: "#/components/schemas/User/properties/user-id" }
    
    put:
      tags: ["Photo Operations"]
      summary: Like a photo
      description: |
        Specifying the photo and the user(me), add a like.
      
      operationId: likePhoto

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: Like added successfully
        
        "400":
          description: Something wrong in the parameters
        
        "401":
          description: You must be logged in before liking a photo
        
        "403":
          description: You already like the photo, cannot like it again, unlike it first
        
        "404":
          description: The specified photo was not found
    
    delete:
      tags: ["Photo Operations"]
      summary: Unlike a photo
      description: |
        Specifying the photo and the user(me), remove a like.
      
      operationId: unlikePhoto

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: Like removed successfully
        
        "400":
          description: Something wrong in the parameters
        
        "401":
          description: You must be logged in before liking a photo
        
        "403":
          description: You already unlike the photo, cannot unlike it again, add a like first
        
        "404":
          description: The specified photo was not found
  
  /photos/{photo-id}/comments/:
    parameters:
      - name: photo-id
        in: path
        required: true
        schema: { $ref: "#/components/schemas/Photo/properties/photo-id" }
    
    post:
      tags: ["Photo Operations"]
      summary: Add a comment to the photo
      description: |
        Given a correct photo-id, add a comment to the comments list of the photo
        and increase its comments-count.
      
      operationId: commentPhoto

      security:
        - BearerAuth: []
      
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Comment" }
      
      responses:
        "200":
          description: Comment added successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Comment" }
        
        "400":
          description: Something is wrong in the parameters or in the request body
        
        "401":
          description: You must be logged in to comment a photo
        
        "404":
          description: The specified photo was not found
  
  /photos/{photo-id}/comments/{comment-id}:
    parameters:
      - name: photo-id
        in: path
        required: true
        schema: { $ref: "#/components/schemas/Photo/properties/photo-id" }
      - name: comment-id
        in: path
        required: true
        schema: { $ref: "#/components/schemas/Comment/properties/comment-id" }
    
    delete:
      tags: ["Photo Operations"]
      summary: Delete a comment
      description: |
        Given a photo-id and a comment-id if correct and the comment belong to the user
        that want to delete it, delete the comment from the photo's list of comments.
      
      operationId: uncommentPhoto

      security:
        - BearerAuth: []
      
      responses:
        "204":
          description: Comment deleted successfully
        
        "400":
          description: Something is wrong in the parameters, check the type
        
        "401":
          description: You have to login before deleting a comment from a photo
        
        "403":
          description: You cannot delete someone else's comment
        
        "404":
          description: The specified photo or the specified comment was not found
